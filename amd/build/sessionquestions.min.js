define("mod_jqshow/sessionquestions",["exports","jquery","core/str","core/ajax","core/modal_factory","core/modal_events","core/templates","core/notification","core/sortable_list","mod_jqshow/modal"],(function(_exports,_jquery,_str,_ajax,_modal_factory,_modal_events,_templates,_notification,_sortable_list,_modal){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.initSessionQuestions=void 0,_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),_sortable_list=_interopRequireDefault(_sortable_list),_modal=_interopRequireDefault(_modal);var cmId,sId,jqshowId,sortable,ACTION_DELETEQUESTION='[data-action="delete_question"]',ACTION_QUESTION=".question-item",ACTION_QUESTIONDROP='.question-item [data-drag-type="move"]',ACTION_QUESTIONPREVIEW='[data-action="question_preview"]',ACTION_ENDCREATESESSION='[data-action="end_create_session"]',SERVICES_DELETEQUESTION="mod_jqshow_deletequestion",SERVICES_SESSIONQUESTIONS="mod_jqshow_sessionquestions",SERVICES_REORDER="mod_jqshow_reorderquestions",SERVICES_GETQUESTION="mod_jqshow_getquestion",SERVICES_ACTIVESESSION="mod_jqshow_activesession",REGION_ROOT='[data-region="question_list"]',REGION_PANEL='[data-region="questions-panel"]',REGION_LOADING='[data-region="overlay-icon-container"]',REGION_SESSIONQUESTIONS='[data-region="session-questions"]',REGION_QUESTIONLIST='[data-region="question_list"]',TEMPLATES_LOADING="core/overlay_loading",TEMPLATES_QUESTIONSSELECTED="mod_jqshow/createsession/sessionquestions",TEMPLATES_QUESTION="mod_jqshow/questions/encasement";function SessionQuestions(selector){this.node=(0,_jquery.default)(selector),sId=this.node.attr("data-sid"),cmId=this.node.attr("data-cmid"),jqshowId=this.node.attr("data-jqshowid"),this.initPanel()}SessionQuestions.prototype.node=null,SessionQuestions.prototype.initPanel=function(){this.node.find(ACTION_DELETEQUESTION).on("click",this.deleteQuestion.bind(this)),this.node.find(ACTION_QUESTIONPREVIEW).on("click",this.questionPreview.bind(this)),sortable instanceof _sortable_list.default||(sortable=new _sortable_list.default(REGION_QUESTIONLIST)),(0,_jquery.default)(REGION_QUESTIONLIST+" > "+ACTION_QUESTIONDROP).on("click",(function(e){e.preventDefault(),e.stopPropagation()})),(0,_jquery.default)(REGION_QUESTIONLIST+" > "+ACTION_QUESTION).on(_sortable_list.default.EVENTS.DROP,this.reorderQuestions.bind(this)),(0,_jquery.default)(ACTION_ENDCREATESESSION).on("click",this.activeSession.bind(this)).removeClass("disabled")},SessionQuestions.prototype.activeSession=function(e){e.preventDefault(),e.stopPropagation();var request={methodname:SERVICES_ACTIVESESSION,args:{cmid:cmId,sessionid:sId}};_ajax.default.call([request])[0].done((function(){window.location.replace(M.cfg.wwwroot+"/mod/jqshow/view.php?id="+cmId)})).fail(_notification.default.exception)},SessionQuestions.prototype.questionPreview=function(e){e.preventDefault(),e.stopPropagation();var questionnId=(0,_jquery.default)(e.currentTarget).attr("data-questionnid");_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){(0,_jquery.default)(REGION_ROOT).append(html);var request={methodname:SERVICES_GETQUESTION,args:{cmid:cmId,sid:sId,jqid:questionnId}};_ajax.default.call([request])[0].done((function(question){_templates.default.render(TEMPLATES_QUESTION,question).then((function(html,js){(0,_str.get_string)("preview","mod_jqshow").done((function(title){_modal_factory.default.create({classes:"modal_jqshow",body:html,title:title,footer:"",type:_modal.default.TYPE}).then((function(modal){modal.getRoot().on(_modal_events.default.hidden,(function(){modal.destroy()})),(0,_jquery.default)(REGION_LOADING).remove(),modal.show(),_templates.default.runTemplateJS(js)})).fail(_notification.default.exception)})).fail(_notification.default.exception)}))}))}))},SessionQuestions.prototype.reloadSessionQuestionsHtml=function(){var request={methodname:SERVICES_SESSIONQUESTIONS,args:{jqshowid:jqshowId,cmid:cmId,sid:sId}};_ajax.default.call([request])[0].done((function(response){_templates.default.render(TEMPLATES_QUESTIONSSELECTED,response).then((function(html,js){(0,_jquery.default)(REGION_SESSIONQUESTIONS).html(html),_templates.default.runTemplateJS(js),(0,_jquery.default)(REGION_LOADING).remove()})).fail(_notification.default.exception)})).fail(_notification.default.exception)},SessionQuestions.prototype.deleteQuestion=function(e){e.preventDefault(),e.stopPropagation();var that=this,questionId=(0,_jquery.default)(e.currentTarget).attr("data-questionnid");(0,_str.get_strings)([{key:"deletequestion",component:"mod_jqshow"},{key:"deletequestion_desc",component:"mod_jqshow"},{key:"confirm",component:"mod_jqshow"}]).then((function(langStrings){var title=langStrings[0],message=langStrings[1],buttonText=langStrings[2];return _modal_factory.default.create({title:title,body:message,type:_modal_factory.default.types.SAVE_CANCEL}).then((function(modal){return modal.setSaveButtonText(buttonText),modal.getRoot().on(_modal_events.default.save,(function(){_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){(0,_jquery.default)(REGION_PANEL).append(html)}));var request={methodname:SERVICES_DELETEQUESTION,args:{qid:questionId,sid:sId}};_ajax.default.call([request])[0].done((function(response){response.deleted?that.reloadSessionQuestionsHtml():((0,_jquery.default)(REGION_LOADING).remove(),alert("no se ha podido borrar la pregunta. intentalo de nuevo mas tarde."))}))})),modal.getRoot().on(_modal_events.default.hidden,(function(){modal.destroy()})),modal}))})).done((function(modal){modal.show()})).fail(_notification.default.exception)},SessionQuestions.prototype.reorderQuestions=function(e){e.preventDefault(),e.stopPropagation();var that=this,allQuestions=(0,_jquery.default)(ACTION_QUESTION),newOrder=[],order=1;allQuestions.each((function(index,question){var questiondata={qid:(0,_jquery.default)(question).attr("data-questionnid"),qorder:order};newOrder.push(questiondata),order++})),newOrder.pop(),_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){(0,_jquery.default)(REGION_PANEL).append(html)}));var request={methodname:SERVICES_REORDER,args:{questions:newOrder}};_ajax.default.call([request])[0].done((function(){that.reloadSessionQuestionsHtml()}))};_exports.initSessionQuestions=function(selector){return new SessionQuestions(selector)}}));

//# sourceMappingURL=sessionquestions.min.js.map