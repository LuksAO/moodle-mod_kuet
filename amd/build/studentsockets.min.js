define("mod_jqshow/studentsockets",["exports","jquery","core/templates","core/notification","core/ajax","mod_jqshow/encryptor","core/event"],(function(_exports,_jquery,_templates,_notification,_ajax,_encryptor,_event){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach((function(key){_defineProperty(target,key,source[key])})):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}return target}function _defineProperty(obj,key,value){return(key=function(arg){var key=function(input,hint){if("object"!==_typeof(input)||null===input)return input;var prim=input[Symbol.toPrimitive];if(void 0!==prim){var res=prim.call(input,hint||"default");if("object"!==_typeof(res))return res;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===hint?String:Number)(input)}(arg,"string");return"symbol"===_typeof(key)?key:String(key)}(key))in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.studentInitSockets=void 0,_jquery=_interopRequireDefault(_jquery),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),_ajax=_interopRequireDefault(_ajax),_encryptor=_interopRequireDefault(_encryptor),_event=_interopRequireDefault(_event);var REGION={MESSAGEBOX:"#message-box",USERLIST:'[data-region="active-users"]',COUNTUSERS:"#countusers",ROOT:'[data-region="student-canvas"]',IMPROVISE:'[data-region="student-improvise"]',IMPROVISEREPLY:".improvise-student-form #reply_student_improvise",TAGSCONTENT:'[data-region="tags-content"]',VOTETAG:'[data-action="vote-tag"]'},ACTIONS_REPLYIMPROVISE='.improvise-response-content [data-action="submit-improvise"]',SERVICES_SESSIONFIINISHED="mod_jqshow_sessionfinished",SERVICES_USERQUESTIONRESPONSE="mod_jqshow_getuserquestionresponse",TEMPLATES_LOADING="core/overlay_loading",TEMPLATES_PARTICIPANT="mod_jqshow/session/manual/waitingroom/participant",TEMPLATES_GROUPPARTICIPANT="mod_jqshow/session/manual/waitingroom/groupparticipant",TEMPLATES_SESSIONFIINISHED="mod_jqshow/session/manual/closeconnection",TEMPLATES_QUESTION="mod_jqshow/questions/encasement",TEMPLATES_PROVISIONALRANKING="mod_jqshow/ranking/provisional",TEMPLATES_IMPROVISESTUDENTRESPONSE="mod_jqshow/session/manual/improvise/studentresponse",portUrl="8080",socketUrl="";function Sockets(region,socketurl,port){this.root=(0,_jquery.default)(region),socketUrl=socketurl,portUrl=port,this.initSockets(),this.disableDevTools(),this.initListeners()}Sockets.prototype.disableDevTools=function(){var _this=this;document.addEventListener("contextmenu",(function(e){return e.preventDefault()})),document.onkeydown=function(e){return!(123===event.keyCode||_this.ctrlShiftKey(e,"I")||_this.ctrlShiftKey(e,"J")||_this.ctrlShiftKey(e,"C")||e.ctrlKey&&e.keyCode==="U".charCodeAt(0))}},Sockets.prototype.ctrlShiftKey=function(e,keyCode){return e.ctrlKey&&e.shiftKey&&e.keyCode===keyCode.charCodeAt(0)},Sockets.prototype.root=null;var userid=null,usersocketid=null,username=null,userimage=null,messageBox=null,countusers=null,cmid=null,sid=null,jqshowid=null,currentCuestionJqid=null,groupid=0,groupmode="",groupimage=null,groupname=null,userHasImprovised=!1,userHasVoted=!1,initVote=!1,notImprovised=!1;Sockets.prototype.initSockets=function(){userid=this.root[0].dataset.userid,username=this.root[0].dataset.username,userimage=this.root[0].dataset.userimage,jqshowid=this.root[0].dataset.jqshowid,cmid=this.root[0].dataset.cmid,sid=this.root[0].dataset.sid,messageBox=this.root.find(REGION.MESSAGEBOX),countusers=this.root.find(REGION.COUNTUSERS),"1"==(groupmode=this.root[0].dataset.groupmode)&&(groupimage=this.root[0].dataset.groupimage,groupid=parseInt(this.root[0].dataset.groupid),groupname=this.root[0].dataset.groupname);var normalizeSocketUrl=Sockets.prototype.normalizeSocketUrl(socketUrl,portUrl);Sockets.prototype.webSocket=new WebSocket(normalizeSocketUrl),Sockets.prototype.webSocket.onopen=function(){},Sockets.prototype.webSocket.onmessage=function(ev){var msgDecrypt=_encryptor.default.decrypt(ev.data),response=JSON.parse(msgDecrypt);switch(response.action){case"alreadyAnswered":"1"==groupmode&&dispatchEvent(new CustomEvent("alreadyAnswered_"+response.jqid,{detail:{userid:response.userid}}));break;case"connect":if(void 0!==response.usersocketid){usersocketid=response.usersocketid;var msg={userid:userid,name:username,pic:userimage,cmid:cmid,sid:sid,usersocketid:usersocketid,action:"newuser"};"1"==groupmode&&(msg.action="newgroup",msg.name=groupname,msg.pic=groupimage,msg.groupid=groupid),Sockets.prototype.sendMessageSocket(JSON.stringify(msg))}break;case"newuser":var identifier=(0,_jquery.default)(REGION.USERLIST),data=response.students;identifier.html(""),_jquery.default.each(data,(function(i,student){var templateContext={usersocketid:student.usersocketid,userimage:student.picture,userfullname:student.name};_templates.default.render(TEMPLATES_PARTICIPANT,templateContext).then((function(html){identifier.append(html)})).fail(_notification.default.exception)})),countusers.html(response.count);break;case"newgroup":var participantshtml=(0,_jquery.default)(REGION.USERLIST),grouplist=response.groups;participantshtml.html(""),_jquery.default.each(grouplist,(function(i,group){var templateContext={usersocketid:group.usersocketid,groupimage:group.picture,groupid:group.groupid,name:group.name,numgroupusers:group.numgroupusers};_templates.default.render(TEMPLATES_GROUPPARTICIPANT,templateContext).then((function(html){participantshtml.append(html)})).fail(_notification.default.exception)})),countusers.html(response.count);break;case"countusers":countusers.html(response.count);break;case"question":_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){var identifier=(0,_jquery.default)(REGION.ROOT);identifier.append(html),currentCuestionJqid=response.context.jqid;var request={methodname:SERVICES_USERQUESTIONRESPONSE,args:{jqid:response.context.jqid,cmid:cmid,sid:sid,uid:0,preview:!1}},removeEvents=new CustomEvent("removeEvents");dispatchEvent(removeEvents),_ajax.default.call([request])[0].done((function(answer){var questionData=_objectSpread(_objectSpread({},response.context.value),answer);_templates.default.render(TEMPLATES_QUESTION,questionData).then((function(html,js){identifier.html(html),_templates.default.runTemplateJS(js),_event.default.notifyFilterContentUpdated(document.querySelector(REGION.ROOT)),(0,_jquery.default)(REGION.LOADING).remove()})).fail(_notification.default.exception)}))}));break;case"ranking":_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){var identifier=(0,_jquery.default)(REGION.ROOT);identifier.append(html);var removeEvents=new CustomEvent("removeEvents");dispatchEvent(removeEvents),_templates.default.render(TEMPLATES_PROVISIONALRANKING,response.context).then((function(html,js){identifier.html(html),_templates.default.runTemplateJS(js),(0,_jquery.default)(REGION.LOADING).remove()})).fail(_notification.default.exception)}));break;case"pauseQuestion":dispatchEvent(new Event("pauseQuestion_"+response.jqid));break;case"playQuestion":dispatchEvent(new Event("playQuestion_"+response.jqid));break;case"showAnswers":dispatchEvent(new Event("showAnswers_"+response.jqid));break;case"hideAnswers":dispatchEvent(new Event("hideAnswers_"+response.jqid));break;case"showStatistics":dispatchEvent(new Event("showStatistics_"+response.jqid));break;case"hideStatistics":dispatchEvent(new Event("hideStatistics_"+response.jqid));break;case"showFeedback":dispatchEvent(new Event("showFeedback_"+response.jqid));break;case"hideFeedback":dispatchEvent(new Event("hideFeedback_"+response.jqid));break;case"improvising":(0,_jquery.default)(REGION.IMPROVISE).removeClass("d-none"),(0,_jquery.default)(REGION.ROOT).addClass("d-none");break;case"closeImprovise":(0,_jquery.default)(REGION.IMPROVISE).addClass("d-none"),(0,_jquery.default)(REGION.ROOT).removeClass("d-none");break;case"improvised":userHasImprovised=!1,userHasVoted=!1,initVote=!1,notImprovised=!1,_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){(0,_jquery.default)(REGION.IMPROVISE).addClass("d-none"),(0,_jquery.default)(REGION.ROOT).removeClass("d-none");var identifier=(0,_jquery.default)(REGION.ROOT);identifier.append(html),_templates.default.render(TEMPLATES_IMPROVISESTUDENTRESPONSE,response).then((function(html){identifier.html(html),(0,_jquery.default)(ACTIONS_REPLYIMPROVISE).on("click",Sockets.prototype.replyImprovise),(0,_jquery.default)(REGION.LOADING).remove()})).fail(_notification.default.exception)}));break;case"printNewTag":var printTags=!1;if(!0===initVote?(!0===userHasVoted&&!1===notImprovised&&(printTags=!0),!0===notImprovised&&(printTags=!0,notImprovised=!1)):printTags=!0,!0===printTags){var htmlTags="";response.tags.forEach((function(tag){htmlTags+='<li><span class="tag" data-count="'+tag.count+'" data-vote="'+tag.votenum+'" data-size="'+tag.size+'"><div class="vote-tag d-none" data-name="'+tag.name+'" data-action="vote-tag"><svg id="vote-layer" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.88 115.29"><defs><style>.cls-1{fill:#212121;}.cls-2{fill:#33a867;fill-rule:evenodd;}</style></defs><path d="M45.22,30.83a5.78,5.78,0,0,1,2.9-3,6.83,6.83,0,0,1,4.66-.26,12.88,12.88,0,0,1,4.45,2.27,22,22,0,0,1,8.14,15.82,45.93,45.93,0,0,1-.1,7c-.13,1.64-.34,3.37-.63,5.16H81.57a18.21,18.21,0,0,1,7.64,1.94,12.43,12.43,0,0,1,4.69,4.12,10.55,10.55,0,0,1,1.71,6.31A14.93,14.93,0,0,1,94.08,76a18.42,18.42,0,0,1,.46,7,8.22,8.22,0,0,1-2.33,4.75A21.3,21.3,0,0,1,91,95.65a16.62,16.62,0,0,1-3.77,5.9,24,24,0,0,1-.75,4.21,14.4,14.4,0,0,1-2.1,4.52h0c-2.88,4.06-5.18,4-8.82,3.81-.51,0-1,0-1.89,0h-33a16,16,0,0,1-7.42-1.49,17.68,17.68,0,0,1-5.83-5.08L27,106.07V67.62l1.68-.45C32.9,66,36.24,62.39,38.85,58a64.87,64.87,0,0,0,5.83-13.95v-10a6.17,6.17,0,0,1,.54-3.25ZM3.38,63.6H19.73A3.39,3.39,0,0,1,23.11,67v44.93a3.39,3.39,0,0,1-3.38,3.38H3.38A3.39,3.39,0,0,1,0,111.91V67A3.39,3.39,0,0,1,3.38,63.6ZM50,31.87a1.82,1.82,0,0,0-.83,1.32V44.4l-.1.64a69.3,69.3,0,0,1-6.38,15.3C39.87,65,36.22,69.09,31.47,71v34.32a12.18,12.18,0,0,0,3.82,3.25,11.76,11.76,0,0,0,5.42,1h33c.59,0,1.35,0,2.07.06,2.16.08,3.52.14,5-1.92h0a9.93,9.93,0,0,0,1.43-3.14,20.11,20.11,0,0,0,.67-4.15l.69-1.48a12.6,12.6,0,0,0,3.27-4.83,17.75,17.75,0,0,0,.87-7.28l-.08-1.33,1.13-.7a3.44,3.44,0,0,0,1.38-2.51,14.87,14.87,0,0,0-.57-6l.18-1.63A11.34,11.34,0,0,0,91.13,70a6.15,6.15,0,0,0-1-3.68,8.06,8.06,0,0,0-3-2.61,13.58,13.58,0,0,0-5.63-1.43H59.26l.5-2.66c.48-2.58.83-5,1-7.37a42.55,42.55,0,0,0,.11-6.33,17.42,17.42,0,0,0-6.39-12.53,8.43,8.43,0,0,0-2.86-1.5,2.56,2.56,0,0,0-1.65,0Z"/></svg></div>'+tag.name+"</span></li>"})),(0,_jquery.default)(REGION.TAGSCONTENT).html(htmlTags),!0===initVote&&!1===userHasVoted&&(0,_jquery.default)(REGION.VOTETAG).removeClass("d-none").on("click",Sockets.prototype.voteTags)}break;case"initVote":initVote=!0,!1===userHasImprovised&&Sockets.prototype.replyImprovise(),(0,_jquery.default)(REGION.VOTETAG).removeClass("d-none").on("click",Sockets.prototype.voteTags);break;case"endSession":(0,_jquery.default)(REGION.IMPROVISE).addClass("d-none"),(0,_jquery.default)(REGION.ROOT).removeClass("d-none"),_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(html){var identifier=(0,_jquery.default)(REGION.ROOT);identifier.append(html),currentCuestionJqid=response.context.jqid,_templates.default.render(TEMPLATES_QUESTION,response.context.value).then((function(html,js){identifier.html(html),_templates.default.runTemplateJS(js),(0,_jquery.default)(REGION.LOADING).remove()})).fail(_notification.default.exception)}));break;case"teacherQuestionEnd":dispatchEvent(new CustomEvent("teacherQuestionEnd_"+response.jqid,{detail:{statistics:response.statistics}}));break;case"userdisconnected":"1"!=groupmode&&((0,_jquery.default)('[data-userid="'+response.usersocketid+'"]').remove(),countusers.html(response.count));break;case"groupdisconnected":(0,_jquery.default)('[data-groupid="'+response.groupid+'"]').remove(),countusers.html(response.count),messageBox.append("<div>"+response.message+"</div>");break;case"groupmemberdisconnected":(0,_jquery.default)(".participants").find('[data-groupid="'+response.groupid+'"]').find(".numgroupusers").html("("+response.count+")"),messageBox.append("<div>"+response.message+"</div>")}messageBox[0].scrollTop=messageBox[0].scrollHeight},Sockets.prototype.webSocket.onerror=function(ev){messageBox.append('<div class="system_error">Error Occurred - '+ev.data+"</div>")},Sockets.prototype.webSocket.onclose=function(){(0,_jquery.default)(REGION.IMPROVISE).addClass("d-none"),(0,_jquery.default)(REGION.ROOT).removeClass("d-none");var request={methodname:SERVICES_SESSIONFIINISHED,args:{jqshowid:jqshowid,cmid:cmid}};_ajax.default.call([request])[0].done((function(response){_templates.default.render(TEMPLATES_SESSIONFIINISHED,response).then((function(html,js){(0,_jquery.default)(REGION.ROOT).html(html),_templates.default.runTemplateJS(js)})).fail(_notification.default.exception)}))}},Sockets.prototype.normalizeSocketUrl=function(socketUrl,port){var jsUrl=new URL(socketUrl);return"https:"===jsUrl.protocol?(jsUrl.port=port,jsUrl.protocol="wss:","/"===jsUrl.pathname?jsUrl.pathname=jsUrl.pathname+"jqshow":jsUrl.pathname=jsUrl.pathname+"/jqshow",jsUrl.toString()):""},Sockets.prototype.initListeners=function(){addEventListener("studentQuestionEnd",(function(){var msg={userid:userid,sid:sid,usersocketid:usersocketid,jqid:currentCuestionJqid,oft:!0,action:"studentQuestionEnd"};if(Sockets.prototype.sendMessageSocket(JSON.stringify(msg)),"1"==groupmode){var msg2={userid:userid,sid:sid,usersocketid:usersocketid,jqid:currentCuestionJqid,ofg:!0,action:"alreadyAnswered"};setTimeout((function(){Sockets.prototype.sendMessageSocket(JSON.stringify(msg2))}),300)}}),!1)},Sockets.prototype.replyImprovise=function(){var improviseReply="";!1===initVote&&""===(improviseReply=(0,_jquery.default)(REGION.IMPROVISEREPLY).val())&&(0,_jquery.default)(REGION.IMPROVISEREPLY).focus((function(){(0,_jquery.default)(REGION.IMPROVISEREPLY).css({"border-color":"red"})})),(!1===initVote&&""!==improviseReply||!0===initVote)&&_templates.default.render(TEMPLATES_LOADING,{visible:!0}).done((function(){(0,_jquery.default)(REGION.IMPROVISE).addClass("d-none"),(0,_jquery.default)(REGION.ROOT).removeClass("d-none"),(0,_jquery.default)(REGION.IMPROVISEREPLY).val("");var cloudtagsData={sessionid:sid,cmid:cmid,improvised:!0,sessionprogress:0,cloudtags:!0,isteacher:!1,questiontext:(0,_jquery.default)(".improvise-statement").text(),programmedmode:!1,preview:!1,tags:[{name:improviseReply,count:1,size:9}]};_templates.default.render(TEMPLATES_QUESTION,cloudtagsData).then((function(html){(0,_jquery.default)(REGION.ROOT).html(html),(0,_jquery.default)(REGION.LOADING).remove();var msg={action:"ImproviseStudentTag",sid:sid,oft:!0,improvisereply:improviseReply,sessionid:sid,cmid:cmid,userid:userid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg)),!1===userHasImprovised&&((0,_jquery.default)(REGION.VOTETAG).removeClass("d-none").on("click",Sockets.prototype.voteTags),notImprovised=!0),userHasImprovised=!0})).fail(_notification.default.exception)}))},Sockets.prototype.voteTags=function(e){(0,_jquery.default)(REGION.VOTETAG).addClass("d-none"),(0,_jquery.default)(REGION.TAGSCONTENT).attr("data-show-votes",!0),(0,_jquery.default)(REGION.TAGSCONTENT).attr("data-show-value",!1);var votedTag=e.target.getAttribute("data-name");if(votedTag){userHasVoted=!0;var msg={action:"StudentVotedTag",sid:sid,oft:!0,votedtag:votedTag,sessionid:sid,cmid:cmid,userid:userid};Sockets.prototype.sendMessageSocket(JSON.stringify(msg))}},Sockets.prototype.sendMessageSocket=function(msg){this.webSocket.send(msg)};_exports.studentInitSockets=function(region,socketurl,port){return new Sockets(region,socketurl,port)}}));

//# sourceMappingURL=studentsockets.min.js.map