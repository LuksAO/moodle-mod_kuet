{"version":3,"file":"studentsockets.min.js","sources":["../src/studentsockets.js"],"sourcesContent":["\"use strict\";\n\nimport jQuery from 'jquery';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport Ajax from 'core/ajax';\n\nlet REGION = {\n    MESSAGEBOX: '#message-box',\n    USERLIST: '[data-region=\"active-users\"]',\n    COUNTUSERS: '#countusers',\n    ROOT: '[data-region=\"student-canvas\"]'\n};\n\nlet SERVICES = {\n    SESSIONFIINISHED: 'mod_jqshow_sessionfinished',\n};\n\nlet TEMPLATES = {\n    LOADING: 'core/overlay_loading',\n    SUCCESS: 'core/notification_success',\n    ERROR: 'core/notification_error',\n    PARTICIPANT: 'mod_jqshow/session/manual/waitingroom/participant',\n    SESSIONFIINISHED: 'mod_jqshow/session/manual/closeconnection',\n};\n\nlet portUrl = '8080';\n\n/**\n * @constructor\n * @param {String} region\n * @param {String} port\n */\nfunction Sockets(region, port) {\n    this.root = jQuery(region);\n    portUrl = port;\n    this.initSockets();\n    this.disableDevTools();\n}\n\nSockets.prototype.disableDevTools = function() {\n    document.addEventListener('contextmenu', (e) => e.preventDefault());\n    document.onkeydown = (e) => {\n        return !(event.keyCode === 123 ||\n            this.ctrlShiftKey(e, 'I') ||\n            this.ctrlShiftKey(e, 'J') ||\n            this.ctrlShiftKey(e, 'C') ||\n            (e.ctrlKey && e.keyCode === 'U'.charCodeAt(0)));\n    };\n};\n\nSockets.prototype.ctrlShiftKey = function(e, keyCode) {\n    return e.ctrlKey && e.shiftKey && e.keyCode === keyCode.charCodeAt(0);\n};\n\n/** @type {jQuery} The jQuery node for the page region. */\nSockets.prototype.root = null;\n\nlet userid = null;\nlet usersocketid = null;\nlet username = null;\nlet userimage = null;\nlet messageBox = null;\nlet countusers = null;\nlet cmid = null;\nlet sid = null;\nlet jqshowid = null;\nconst password = 'elktkktagqes';\nconst abc = 'abcdefghijklmnopqrstuvwxyz0123456789=ABCDEFGHIJKLMNOPQRSTUVWXYZ/+-*';\n\nSockets.prototype.initSockets = function() {\n    userid = this.root[0].dataset.userid;\n    username = this.root[0].dataset.username;\n    userimage = this.root[0].dataset.userimage;\n    jqshowid = this.root[0].dataset.jqshowid;\n    cmid = this.root[0].dataset.cmid;\n    sid = this.root[0].dataset.sid;\n    messageBox = this.root.find(REGION.MESSAGEBOX);\n    countusers = this.root.find(REGION.COUNTUSERS);\n\n    Sockets.prototype.webSocket = new WebSocket(\n        'wss://' + M.cfg.wwwroot.replace(/^https?:\\/\\//, '') + ':' + portUrl + '/jqshow'\n    );\n\n    Sockets.prototype.webSocket.onopen = function() {\n        /* TODO call service to get all the quiz questions,\n            and generate an iterator to call .next() each time the socket/professor says so. */\n    };\n\n    Sockets.prototype.webSocket.onmessage = function(ev) {\n        let msgDecrypt = Sockets.prototype.decrypt(password, ev.data);\n        let response = JSON.parse(msgDecrypt); // PHP sends Json data.\n        let resAction = response.action; // Message type.\n        switch (resAction) {\n            case 'connect':\n                // The server has returned the connected status, it is time to identify yourself.\n                if (response.usersocketid !== undefined) {\n                    usersocketid = response.usersocketid;\n                    let msg = {\n                        'userid': userid,\n                        'name': username,\n                        'pic': userimage, // TODO encrypt.\n                        'cmid': cmid,\n                        'sid': sid,\n                        'usersocketid': usersocketid,\n                        'action': 'newuser',\n                    };\n                    Sockets.prototype.sendMessageSocket(JSON.stringify(msg));\n                }\n                break;\n            case 'newuser': {\n                let identifier = jQuery(REGION.USERLIST);\n                let data = response.students;\n                identifier.html('');\n                jQuery.each(data, function (i, student) {\n                    let templateContext = {\n                        'usersocketid': student.usersocketid,\n                        'userimage': student.picture,\n                        'userfullname': student.name,\n                    };\n                    Templates.render(TEMPLATES.PARTICIPANT, templateContext).then(function(html) {\n                        identifier.append(html);\n                    }).fail(Notification.exception);\n                });\n                countusers.html(response.count);\n                break;\n            }\n            case 'countusers':\n                countusers.html(response.count);\n                break;\n            case 'userdisconnected':\n                jQuery('[data-userid=\"' + response.usersocketid + '\"]').remove();\n                countusers.html(response.count);\n                break;\n            default:\n                break;\n        }\n        messageBox[0].scrollTop = messageBox[0].scrollHeight;\n    };\n\n    Sockets.prototype.webSocket.onerror = function(ev) {\n        messageBox.append('<div class=\"system_error\">Error Occurred - ' + ev.data + '</div>');\n    };\n\n    Sockets.prototype.webSocket.onclose = function() {\n        let request = {\n            methodname: SERVICES.SESSIONFIINISHED,\n            args: {\n                jqshowid: jqshowid,\n                cmid: cmid\n            }\n        };\n        Ajax.call([request])[0].done(function(response) {\n            Templates.render(TEMPLATES.SESSIONFIINISHED, response).then(function(html, js) {\n                jQuery(REGION.ROOT).html(html);\n                Templates.runTemplateJS(js);\n            }).fail(Notification.exception);\n        });\n    };\n};\n\nSockets.prototype.sendMessageSocket = function(msg) {\n    this.webSocket.send(msg);\n};\n\nSockets.prototype.decrypt = function(password, text) {\n    const arr = text.split('');\n    const arrPass = password.split('');\n    let lastPassLetter = 0;\n    let decrypted = '';\n    for (let i = 0; i < arr.length; i++) {\n        const letter = arr[i];\n        const passwordLetter = arrPass[lastPassLetter];\n        const temp = this.getInvertedLetterFromAlphabetForLetter(passwordLetter, letter);\n        if (temp) {\n            decrypted += temp;\n        } else {\n            return null;\n        }\n        if (lastPassLetter === (arrPass.length - 1)) {\n            lastPassLetter = 0;\n        } else {\n            lastPassLetter++;\n        }\n    }\n    return atob(decrypted);\n};\n\nSockets.prototype.getInvertedLetterFromAlphabetForLetter = function(letter, letterToChange) {\n    const posLetter = abc.indexOf(letter);\n    if (posLetter == -1) {\n        // eslint-disable-next-line no-console\n        console.log('Password letter ' + letter + ' not allowed.');\n        return null;\n    }\n\n    const part1 = abc.substring(posLetter, abc.length);\n    const part2 = abc.substring(0, posLetter);\n    const newABC = '' + part1 + '' + part2;\n    const posLetterToChange = newABC.indexOf(letterToChange);\n\n    if (posLetterToChange == -1) {\n        // eslint-disable-next-line no-console\n        console.log('Password letter ' + letter + ' not allowed.');\n        return null;\n    }\n\n    return abc.split('')[posLetterToChange];\n};\n\nSockets.prototype.encrypt = function(password, text) {\n    const base64 = btoa(text);\n    const arr = base64.split('');\n    const arrPass = password.split('');\n    let lastPassLetter = 0;\n    let encrypted = '';\n    for (let i = 0; i < arr.length; i++) {\n        const letter = arr[i];\n        const passwordLetter = arrPass[lastPassLetter];\n        const temp = this.getLetterFromAlphabetForLetter(passwordLetter, letter);\n        if (temp) {\n            encrypted += temp;\n        } else {\n            return null;\n        }\n        if (lastPassLetter === (arrPass.length - 1)) {\n            lastPassLetter = 0;\n        } else {\n            lastPassLetter++;\n        }\n    }\n    return encrypted;\n};\n\nSockets.prototype.getLetterFromAlphabetForLetter = function(letter, letterToChange) {\n    const posLetter = abc.indexOf(letter);\n    if (posLetter == -1) {\n        // eslint-disable-next-line no-console\n        console.log('Password letter ' + letter + ' not allowed.');\n        return null;\n    }\n    const posLetterToChange = abc.indexOf(letterToChange);\n    if (posLetterToChange == -1) {\n        // eslint-disable-next-line no-console\n        console.log('Password letter ' + letter + ' not allowed.');\n        return null;\n    }\n    const part1 = abc.substring(posLetter, abc.length);\n    const part2 = abc.substring(0, posLetter);\n    const newABC = '' + part1 + '' + part2;\n    return newABC.split('')[posLetterToChange];\n};\n\nexport const studentInitSockets = (region, port) => {\n    return new Sockets(region, port);\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","Object","defineProperty","_exports","value","studentInitSockets","_jquery","_templates","_notification","_ajax","REGION","SERVICES","TEMPLATES","portUrl","Sockets","region","port","this","root","jQuery","initSockets","disableDevTools","prototype","_this","document","addEventListener","e","preventDefault","onkeydown","event","keyCode","ctrlShiftKey","ctrlKey","charCodeAt","shiftKey","userid","usersocketid","username","userimage","messageBox","countusers","cmid","sid","jqshowid","abc","dataset","find","webSocket","WebSocket","M","cfg","wwwroot","replace","onopen","onmessage","ev","msgDecrypt","decrypt","data","response","JSON","parse","action","undefined","msg","name","pic","sendMessageSocket","stringify","identifier","students","html","each","i","student","templateContext","picture","userfullname","Templates","render","then","append","fail","Notification","exception","count","remove","scrollTop","scrollHeight","onerror","onclose","request","methodname","args","Ajax","call","done","js","runTemplateJS","send","password","text","arr","split","arrPass","lastPassLetter","decrypted","length","letter","passwordLetter","temp","getInvertedLetterFromAlphabetForLetter","atob","letterToChange","posLetter","indexOf","console","log","posLetterToChange","substring","encrypt","btoa","encrypted","getLetterFromAlphabetForLetter"],"mappings":"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"}